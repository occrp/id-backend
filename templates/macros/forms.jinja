{% macro render_radiofield(field) %}
    {% for value, label in field.field.choices %}
        <label class="radio">
            <input type="radio" name="{{ field.html_name }}" {% if field.value() == value %}checked="checked"{% endif %}
                   id="{{ field.auto_id }}-{{ loop.index }}" value="{{ value }}">
            {{ label }}
        </label>
    {% endfor %}
{% endmacro %}

{% macro render_datefield(field) %}
    <div class="input-append">
        <input type="text" name="{{ field.html_name }}" id="{{ field.auto_id }}"
               {% if field.value() %}value="{{ field.value() }}"{% endif %}
               class="{{ get_widget_classes(field) }}" />
        <span class="add-on"><i class="icon-calendar"></i></span>
    </div>
{% endmacro %}

{% macro render_filefield(field) %}
    <div class="fileupload fileupload-new" data-provides="fileupload">
        <div class="input-append">
            <div class="uneditable-input span3">
                <i class="icon-file fileupload-exists"></i>
                <span class="fileupload-preview"></span>
            </div>
            <span class="btn btn-file">
                <span class="fileupload-new">{% trans %}Select File{% endtrans %}</span>
                <span class="fileupload-exists">{% trans %}Change{% endtrans %}</span>
                {{ field }}
            </span>
            <a href="#" class="btn fileupload-exists" data-dismiss="fileupload">{% trans %}Remove{% endtrans %}</a>
        </div>
        {{ render_errors(field) }}
    </div>
{% endmacro %}

{% macro render_classedtextareafield(field) %}
    <textarea class="{{ field.css_class }}" 
            {% if field.placeholder %}placeholder="{{ field.placeholder }}"{% endif %}
            name="{{ field.name }}" id="{{ field.name }}" rows="{{ field.rows }}">{{ field.value if field.value else '' }}</textarea>
{% endmacro %}

{% macro render_drivefield(field) %}
    <button type="button" class="btn" data-toggle="drive-picker" data-spinner="after" data-type="form">
        {% trans %}Attach Files{% endtrans %}
    </button>
    {{ field }}
    <div class="selected-files" style="display: none;"></div>
{% endmacro %}

{% macro render_hiddendrivefield(field) %}
    {{ field }}
    <div class="selected-files" style="display: none;"></div>
{% endmacro %}

{% macro render_keyfield(field) %}
    <input type="hidden" name="{{ field.html_name }}" id="{{ field.auto_id }}-1" value="{{ field.value.urlsafe() }}" />
    <input type="text" disabled="disabled" name="{{ field.html_name }}" id="{{ field.auto_id }}-2" value="{% if field.value -%}
        {{ field.value.get().name }}
    {%- endif %}" />
{% endmacro %}

{% macro render_hiddenkeyfield(field) %}
    <input type="hidden" name="{{ field.html_name }}" id="{{ field.auto_id }}" value="{{ field.get_value() }}" />
{% endmacro %}

{% macro render_select2field(field) %}
    <input type="hidden" name="{{ field.html_name }}" id="{{ field.auto_id }}" 
            value="{% if field.value %}{{ field.get_value() }}{% endif %}"
           data-provide="select2-field" 
           data-placeholder="{% if field.value %}{{ field.placeholder }}{% endif %}" 
           data-ajax-url="{{ field.ajax_url }}"
           data-multiple="{{ field.multiple }}"
           {% if field.options %}
            data-options="{{ field.auto_id }}_options"
           {% endif %}
           data-text="{% if field.value %}{{ field.get_text() }}{% endif %}"/>

    {% if field.options %}
    <script type="text/javascript">
        var {{ field.auto_id }}_options = JSON.parse('{{ field.options|safe }}');
    </script>
    {% endif %}
{% endmacro %}

{% macro render_errors(field) %}
    {% if field.errors %}
        <span class="help-inline">
        {% for error in field.errors %}
            {{ error }}
        {% endfor %}
    </span>
    {% endif %}
{% endmacro %}

{% macro render_helptext(field) %}
    {% if field.description %}
        <p class="help-block">{{ field.description|safe }}</p>
    {% endif %}
{% endmacro %}

{% macro render_field(field) %}
    {% if field.type == 'HiddenField' %}
        {{ field }}
    {% elif field.type == 'HiddenKeyField' %}
        {{ render_hiddenkeyfield(field) }}
    {% else %}
        <div class="control-group {% if field.errors %}error{% endif %}">
            {% if field.name != "" %}
            <label class="control-label" for="{{ field.auto_id }}">
                {{ get_verbose_or_field_name(field) }}{% if field.field.required %}*{% endif %}
            </label>
            {% endif %}
            <div class="controls">
                {% if get_field_type(field) == 'RadioField' or get_field_type(field) == 'RadioSelect'  %}
                    {{ render_radiofield(field) }}
                {% elif get_field_type(field) == 'DateField' or get_field_type(field) == 'DateInput' %}
                    {{ render_datefield(field) }}
                {% elif get_field_type(field) == 'FileField' %}
                    {{ render_filefield(field) }}
                {% elif get_field_type(field) == 'HiddenDriveField' %}
                    {{ render_hiddendrivefield(field) }}
                {% elif get_field_type(field) == 'DriveField' %}
                    {{ render_drivefield(field) }}
                {% elif get_field_type(field) == 'KeyField' %}
                    {{ render_keyfield(field) }}
                {% elif get_field_type(field) == 'Select2Field' %}
                    {{ render_select2field(field) }}
                {% elif get_field_type(field) == 'ClassedTextAreaField' %}
                    {{ render_classedtextareafield(field) }}
                {% else %}
                    {{ field }}
                {% endif %}
                {% if get_field_type(field) != 'FileField'
                    and get_field_type(field) != 'HiddenFileField' %}
                    {{ render_errors(field) }}
                    {{ render_helptext(field) }}
                {% endif %}
            </div>
        </div>
    {% endif %}
{% endmacro %}

{% macro render_submit(submit_title, class="btn-primary") %}
    <div class="form-actions">
        <button class="btn {{ class }}" type="submit">{{ submit_title }}</button>
    </div>
{% endmacro %}

{% macro render_form_fragment(form) %}
    {% if form.Meta and form.Meta.fields %}
        {# Render all fields in a defined order #}
        {% for name in form.fields %}
            {{ render_field(form[name]) }}
        {% endfor %}
    {% else %}
        {# Render all fields in the order that they were added #}
        {% for field in form %}
            {{ render_field(field) }}
        {% endfor %}
    {% endif %}
{% endmacro %}

{% macro render_form(form, submit_class="btn-primary", submit_title="", class="form-horizontal") %}
    <form method="POST" class="{{ class }}" 
        enctype="multipart/form-data" 
        {% if form.Meta and form.Meta.ajax_validation_url -%}
            data-validation-url="{{ form.Meta.ajax_validation_url }}"
        {%- endif %}>
        {% if form.Meta and form.Meta.ajax_validation_url and form.instance.key %}
            <input type="hidden" name="validation_key" value="{{ form.instance.key.urlsafe() }}"/>
        {% endif %}

        {{ render_form_fragment(form) }}
        {% if submit_title %}
            {{ render_submit(submit_title, submit_class) }}
        {% endif %}
    </form>
{% endmacro %}
